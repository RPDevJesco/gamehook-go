<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Mario Bros - GameHook Overlay</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background: transparent;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .overlay-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #FFD700;
        }

        .stat-label {
            color: #FFD700;
            font-weight: bold;
        }

        .stat-value {
            color: #FFFFFF;
        }

        .mario-sprite {
            width: 32px;
            height: 32px;
            display: inline-block;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAFYSURBVCiRpZM9SwNBEIafgwQSCwsLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sLwcJCG1sL') no-repeat;
            background-size: contain;
            margin-right: 8px;
        }

        .world-level {
            font-size: 24px;
            text-align: center;
            background: rgba(255, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .connected {
            background: #4CAF50;
            color: white;
        }

        .disconnected {
            background: #f44336;
            color: white;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="status-indicator disconnected" id="status">DISCONNECTED</div>

<div class="overlay-container">
    <div class="world-level">
        <span id="world">?</span>-<span id="level">?</span>
    </div>

    <div class="stat-row">
            <span class="stat-label">
                <span class="mario-sprite"></span>
                LIVES
            </span>
        <span class="stat-value" id="lives">?</span>
    </div>

    <div class="stat-row">
        <span class="stat-label">COINS</span>
        <span class="stat-value" id="coins">?</span>
    </div>

    <div class="stat-row">
        <span class="stat-label">SCORE</span>
        <span class="stat-value" id="score">?</span>
    </div>

    <div class="stat-row">
        <span class="stat-label">POWER</span>
        <span class="stat-value" id="power">?</span>
    </div>

    <div class="stat-row">
        <span class="stat-label">TIME</span>
        <span class="stat-value" id="time">?</span>
    </div>

    <div class="stat-row">
        <span class="stat-label">POSITION</span>
        <span class="stat-value" id="position">?</span>
    </div>
</div>

<script>
    class GameHookClient {
        constructor(baseUrl = 'http://localhost:8080') {
            this.baseUrl = baseUrl;
            this.ws = null;
            this.connected = false;
            this.reconnectInterval = 2000;
        }

        async connect() {
            try {
                // Test HTTP connection first
                const response = await fetch(`${this.baseUrl}/api/mappers`);
                if (!response.ok) throw new Error('HTTP connection failed');

                // Establish WebSocket connection
                this.ws = new WebSocket(`ws://localhost:8080/api/stream`);

                this.ws.onopen = () => {
                    console.log('Connected to GameHook');
                    this.connected = true;
                    this.updateStatus();
                    this.loadInitialData();
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };

                this.ws.onclose = () => {
                    console.log('Disconnected from GameHook');
                    this.connected = false;
                    this.updateStatus();
                    setTimeout(() => this.connect(), this.reconnectInterval);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

            } catch (error) {
                console.error('Connection failed:', error);
                this.connected = false;
                this.updateStatus();
                setTimeout(() => this.connect(), this.reconnectInterval);
            }
        }

        updateStatus() {
            const status = document.getElementById('status');
            if (this.connected) {
                status.textContent = 'CONNECTED';
                status.className = 'status-indicator connected';
            } else {
                status.textContent = 'DISCONNECTED';
                status.className = 'status-indicator disconnected';
            }
        }

        async loadInitialData() {
            try {
                // Load all properties
                const properties = ['world', 'level', 'marioLives', 'coinCount', 'score', 'powerupState', 'timeHundreds', 'timeTens', 'timeOnes', 'playerX', 'playerY'];

                for (const prop of properties) {
                    try {
                        const response = await fetch(`${this.baseUrl}/api/properties/${prop}`);
                        if (response.ok) {
                            const data = await response.json();
                            this.updateProperty(prop, data.value);
                        }
                    } catch (error) {
                        console.warn(`Failed to load property ${prop}:`, error);
                    }
                }
            } catch (error) {
                console.error('Failed to load initial data:', error);
            }
        }

        handleMessage(data) {
            if (data.type === 'property_changed') {
                this.updateProperty(data.property, data.value);
            }
        }

        updateProperty(name, value) {
            switch (name) {
                case 'world':
                    document.getElementById('world').textContent = value || '?';
                    break;
                case 'level':
                    document.getElementById('level').textContent = value || '?';
                    break;
                case 'marioLives':
                    document.getElementById('lives').textContent = value || '?';
                    break;
                case 'coinCount':
                    document.getElementById('coins').textContent = value || '?';
                    break;
                case 'score':
                    document.getElementById('score').textContent =
                        value ? value.toLocaleString() : '?';
                    break;
                case 'powerupState':
                    document.getElementById('power').textContent = value || '?';
                    break;
                case 'timeHundreds':
                case 'timeTens':
                case 'timeOnes':
                    this.updateTime();
                    break;
                case 'playerX':
                case 'playerY':
                    this.updatePosition();
                    break;
            }
        }

        updateTime() {
            const hundreds = document.getElementById('timeHundreds')?.textContent || '0';
            const tens = document.getElementById('timeTens')?.textContent || '0';
            const ones = document.getElementById('timeOnes')?.textContent || '0';
            document.getElementById('time').textContent = `${hundreds}${tens}${ones}`;
        }

        updatePosition() {
            const x = document.getElementById('playerX')?.textContent || '?';
            const y = document.getElementById('playerY')?.textContent || '?';
            document.getElementById('position').textContent = `${x}, ${y}`;
        }
    }

    // Initialize client
    const client = new GameHookClient();
    client.connect();

    // Fallback polling if WebSocket fails
    setInterval(async () => {
        if (!client.connected) {
            try {
                await client.loadInitialData();
            } catch (error) {
                // Ignore errors in fallback mode
            }
        }
    }, 1000);
</script>
</body>
</html>